#!/usr/bin/python3
# -*- coding: UTF-8 -*-
# version: "1.0"
# author: "FreeK0x00"

import socket
import sys
import threading
import argparse
import time

def PortConnect(ip, p):
	""" Creates a TCP socket and attempts to connect via supplied ports """
	sql_port = [3306, 1521, 1433, 5432, 27017]
	port = int(p)
	try:
		# Create a new socket
		s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
		if port in sql_port:
			s.settimeout(5)
		else:
			s.settimeout(0.2)
		# Print if the port is open
		if not s.connect_ex((ip, port)):
			print('[+] %s:%d/TCP Open' % (ip, port))
	except Exception:
		pass
	finally:
		s.close()


def GetPorts(ip, ports):
	print('[*] Starting TCP port scan on IP %s' % ip)
	for p in ports:
		PortConnect(ip, p)
	print('[*] TCP scan on IP %s complete' % ip)


def CscanPort(ip, ports):
	if '/24' in ip:
		print('ip/24: '+ip)
		ipc = (ip.split('.')[:-1])
		for i in range(1, 256):
			ip = ('.'.join(ipc)+'.'+str(i))
			threading._start_new_thread(GetPorts(ip, ports))
			time.sleep(0.1)


def BscanPort(ip, ports):
	if '/16' in ip:
		print('ip/16: '+ip)
		ipc = (ip.split('.')[:-2])
		for i in range(1, 256):
			ip = ('.'.join(ipc)+'.'+str(i)+'.0/24')
			CscanPort(ip, ports)


def AscanPort(ip, ports):
	if '/8' in ip:
		print('ip/8: '+ip)
		ipc = (ip.split('.')[:-3])
		for i in range(1, 256):
			ip = ('.'.join(ipc)+'.'+str(i)+'.0/16')
			BscanPort(ip, ports)


Usage = """
	Usage eg:
	python3 PortScan.py -i 192.168.0.1 # Default Ports Scan
	python3 PortScan.py -i 192.168.0.1 -p 8080,8081,4444
	python3 PortScan.py -i 192.168.0.1 -p 8080-8085
	python3 PortScan.py -i 192.168.0.1 -p 8080,8081,4441-4445
	python3 PortScan.py -i 192.168.0.1/24 -p 8080,8081,4441-4445
	python3 PortScan.py -i 172.16.0.1/16 -p 8080,8081,4441-4445
	python3 PortScan.py -i 10.0.0.1/8 -p 8080,8081,4441-4445
	......
	"""

if __name__ == '__main__':
	parser = argparse.ArgumentParser()
	parser.add_argument('-i', '--ip', help='IP or IP/24')
	parser.add_argument('-p', '--port', help="Example: 80 80-89 80,443,3306,8080")
	parser.add_argument('-f', '--ip_file', help="ip.txt ip24.txt ip16.txt ip8.txt")
	args = parser.parse_args()
	ip = args.ip
	tmpPorts = args.port
	ipfile = args.ip_file
	if ip is None and ipfile is None:
		print('[-] Error: ip or ipfile is Null!')
		print('[-] Help: python3 PortConnect.py -h or --help')
		print(Usage)
		sys.exit(1)
	if tmpPorts:
		if ',' in tmpPorts and '-' not in tmpPorts:
			ports = tmpPorts.split(',')
			print(ports)
		elif '-' in tmpPorts and ',' not in tmpPorts:
			ports = tmpPorts.split('-')
			tmpports = []
			[tmpports.append(i) for i in range(int(ports[0]), int(ports[1]) + 1)]
			ports = tmpports
			print(ports)
		elif '-' in tmpPorts and ',' in tmpPorts:
			ports = tmpPorts.split(',')
			for p in ports:
				if '-' in str(p):
					ports.remove(p)
					tmp = p.split('-')
					[ports.append(str(i)) for i in range(int(tmp[0]), int(tmp[1]) + 1)]
			print(ports)
		else:
			print('[-] Error: portlist is illegal!! Please check and try again!!')
			sys.exit(1)

	else:
		print('Start Scan {} Default Ports'.format(ip))
		ports = [21, 22, 53, 80, 135, 139, 389, 443, 445, 1025, 1433, 1521, 3306, 3312, 3389, 4444, 5432, 5900, 6379, 7001, 8000, 8080, 8081, 8082, 8083, 8090, 8444, 8888, 27017]
		print('Default Ports list: ', ports)
	if ip:
		if '/8' in ip:
			AscanPort(ip, ports)
		elif '/16' in ip:
			BscanPort(ip, ports)
		elif '/24' in ip:
			CscanPort(ip, ports)
		else:
			GetPorts(ip, ports)
